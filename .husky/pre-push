echo "Хук выполняет действия перед отправкой коммитов в origin..."

PARENT_BRANCH=main # ветка, от которой отпочковываемся и с которой будем сравнивать
CURRENT_BRANCH=$(git branch --show-current)
ON_ORIGIN=$(git show-ref --verify --quiet refs/remotes/origin/$CURRENT_BRANCH && echo true || echo false)

AHEAD_COMMIT_COUNT=0
if [ "$ON_ORIGIN" = true ]
then
    # если ветка опубликована, то считаем отстающие коммиты от нее
    AHEAD_COMMIT_COUNT=$(git rev-list --count @{u}..HEAD)
else
    # если ветка не опубликована, то считаем отстающие коммиты от родительской
    BRANCH_POINT=$(git merge-base $PARENT_BRANCH $CURRENT_BRANCH)
    AHEAD_COMMIT_COUNT=$(git rev-list --count $BRANCH_POINT..HEAD)
fi

echo "Обнаружено $AHEAD_COMMIT_COUNT коммитов, готовых к отправке. Проверяем наличие изменений в папке backend..."
AHEAD_COMMITS=($(git log $(git branch --show-current) --format="%H" --first-parent -$AHEAD_COMMIT_COUNT))
NEED_GENERATE="false"

for COMMIT in "${AHEAD_COMMITS[@]}"; do
    HAS_CHANGES_IN_BACKEND=$(git show --name-only "$COMMIT" | grep -q "^backend/" && echo true || echo false)
    if [ "$HAS_CHANGES_IN_BACKEND" = true ]
    then
        NEED_GENERATE="true"
    fi
done

if [ "$NEED_GENERATE" = true ]
then
    echo "Обнаружены изменения в папке backend. Выполнется сборка и перегенерация..."

    GS1=$(git status)
    cd ./backend
    npm run generate
    cd ../
    GS2=$(git status)

    if [ "$GS1" != "$GS2" ]
    then
        echo "В результате перегенерации файл обновился. Коммитим его..."
        sleep 2 && git add ./generated/result.txt && git commit -m "Generated changes" &
        exit 0
    fi
fi
